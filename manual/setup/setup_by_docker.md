# Installation of SeaTicket Server with Docker

## System requirements

In general, we recommend that you have at least 2G RAM and a 2-core CPU (> 2GHz).

## Getting started

The following assumptions and conventions are used in the rest of this document:

- `/opt/seaticket` is the directory for store SeaTicket docker compose files. If you decide to put SeaTicket in a different directory — which you can — adjust all paths accordingly.
- SeaTicket uses two [Docker volumes](https://docs.docker.com/storage/volumes/) for persisting data generated in its database and SeaTicket Docker container. The volumes' [host paths](https://docs.docker.com/compose/compose-file/compose-file-v3/#volumes) are `/opt/mysql-data` and `/opt/seaticket-data`, respectively. It is not recommended to change these paths. If you do, account for it when following these instructions.
- All configuration and log files for SeaTicket and the webserver Nginx are stored in the volume of the SeaTicket container.

### Install docker

Use the [official installation guide for your OS to install Docker](https://docs.docker.com/engine/install/).

### Download and modify `.env`

To deploy SeaTicket with Docker, you have to `.env`, `seaticket.yml`  and `config.yml` in a directory (e.g., `/opt/seaticket`):

```bash
mkdir /opt/seaticket
cd /opt/seaticket

wget -O .env https://manual.seaticket.ai/main/repo/docker/env
wget https://manual.seaticket.ai/main/repo/docker/seaticket.yml
wget https://manual.seaticket.ai/main/repo/docker/config.yaml

nano .env
```

The following fields merit particular attention:

| Variable                        | Description                                                                                                   | Default Value                   |  
| ------------------------------- | ------------------------------------------------------------------------------------------------------------- | ------------------------------- |  
| `SEATICKET_VOLUME`                | The volume directory of SeaTicket data                                                                          | `/opt/seaticket-data`             |  
| `MYSQL_VOLUME`          | The volume directory of MySQL data                                                                            | `/opt/mysql-data`         |  
| `CADDY_VOLUME`          | The volume directory of Caddy data used to store certificates obtained from Let's Encrypt's                    | `/opt/caddy-data`            |  
| `INIT_MYSQL_ROOT_PASSWORD` | The `root` password of MySQL                                                                                  | (Only required on first deployment) |  
| `MYSQL_HOST`         | The host of MySQL | `db`  | 
| `MYSQL_PORT`         | The port of MySQL | `3306`  | 
| `MYSQL_USER`         | The user of MySQL |`seaticket`  |  
| `MYSQL_PASSWORD`     | The user `seaticket` password of MySQL                                                                          | (required)  |  
| `MYSQL_DB_NAME`     | The database name of seaticket | `seaticket_db`  |
| `JWT_PRIVATE_KEY`                           | JWT_PRIVATE_KEY, A random string with a length of no less than 32 characters is required for SeaTicket, which can be generated by using `pwgen -s 40 1` | (required) |  
| `SEATICKET_HOSTNAME`       | SeaTicket hostname or domain                                                                  | (required)  |  
| `SEATICKET_PROTOCOL`       | SeaTicket protocol (http or https)                                                                       | `http` |
| `REDIS_HOST`       | Redis server host | `redis` |
| `REDIS_PORT`       | Redis server port | `6379` |
| `REDIS_PASSWORD`       | Redis server password | (required) |
| `TIME_ZONE`                     | Time zone                                                                                                     | `UTC`                           |
| `INIT_SEATICKET_ADMIN_EMAIL`      | Admin username                                                                                                | `me@example.com` (Recommend modifications) |  
| `INIT_SEATICKET_ADMIN_PASSWORD`   | Admin password       | `asecret` (Recommend modifications) |
| `NON_ROOT`   | Run SeaTicket container without a root user      | `false` |

### Start SeaTicket server

Start SeaTicket server with the following command

```bash
docker compose up -d
```

!!! warning "ERROR: Named volume "xxx" is used in service "xxx" but no declaration was found in the volumes section"
    You may encounter this problem when your Docker (or docker-compose) version is out of date. You can upgrade or reinstall the Docker service to solve this problem according to the [Docker official documentation](https://docs.docker.com/engine/install/).

!!! note
    You must run the above command in the directory with the `.env`. If `.env` file is elsewhere, please run

    ```sh
    docker compose --env-file /path/to/.env up -d
    ```

### Init FoundationDB

You need to initialize the foundation data. Please run the following command:

```bash
docker exec -it fdb bash

fdbcli

# wait for a while, then input the following commands
configure new single ssd
configure storage_migration_type=aggressive
configure ssd
```

Finially, you can go to `http://seaticket.example.com` to use SeaTicket.

## SeaTicket directory structure

### Path `/opt/seaticket-data`

Placeholder spot for shared volumes. You may elect to store certain persistent information outside of a container, in our case we keep various log files and upload directory outside. This allows you to rebuild containers easily without losing important information.

* /opt/seaticket-data: This is the directory for seaticket server configuration and data.
    * /opt/seaticket-data/logs: This is the directory that would contain the log files of seaticket server processes. For example, you can find seaf-server logs in `/opt/seaticket-data/seaticket/logs/seaticket.log`.

### Find logs

To monitor container logs (from outside of the container), please use the following commands:

```bash
# if the `.env` file is in current directory:
docker compose logs --follow
# if the `.env` file is elsewhere:
docker compose --env-file /path/to/.env logs --follow

# you can also specify container name:
docker compose logs seaqa-web --follow
# or, if the `.env` file is elsewhere:
docker compose --env-file /path/to/.env logs seaqa-web --follow
```

The SeaTicket logs are under `/shared/logs` in the docker, or `/opt/seaticket-data/logs/seaticket` in the server that run the docker.

To monitor all SeaTicket logs simultaneously (from outside of the container), run

```bash
sudo tail -f $(find /opt/seaticket-data/ -type f -name *.log 2>/dev/null)
```

## More configuration options

config.yaml

## Add a new admin

Ensure the container is running, then enter this command:

```bash
docker exec -it seaqa-web /scripts/reset-admin.sh
```

Enter the username and password according to the prompts. You now have a new admin account.

## Backup and recovery

Follow the instructions in [Backup and restore for SeaTicket Docker](../administration/backup_recovery.md)


## FAQ

### SeaTicket service and container maintenance

Q: If I want enter into the Docker container, which command I can use?

A: You can enter into the docker container using the command:

```bash
docker exec -it seaqa-web /bin/bash
```


Q: I forgot the SeaTicket admin email address/password, how do I create a new admin account?

A: You can create a new admin account by running

```shell
docker exec -it seaqa-web /scripts/reset-admin.sh
```

The SeaTicket service must be up when running the superuser command.


Q: If, for whatever reason, the installation fails, how do I to start from a clean slate again?

A: Remove the directories /opt/seaticket, /opt/seaticket-data and /opt/mysql-data and start again.


Q: Something goes wrong during the start of the containers. How can I find out more?

A: You can view the docker logs using this command: `docker compose logs -f`.
